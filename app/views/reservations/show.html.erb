<% @page_title = "予約詳細" %>
<h1>予約詳細</h1>

<div class="completion-box">
	<div class="status-display mb-20 font-bold">
		現在のステータス: 
		<span class="status-<%= @reservation.status %>">
			<% 
				status_labels = {
					'pending' => '未承認',
					'rejected' => '却下',
					'approved_unpaid' => '承諾(未払い)',
					'approved_paid' => '承諾(支払い済み)',
					'completed' => '完了',
					'canceled' => 'キャンセル',
					'admin_canceled' => '管理者キャンセル'
				}
			%>
			<%= status_labels[@reservation.status] || @reservation.status %>
		</span>
	</div>

	<table class="list">
		<tr>
			<th>予約番号</th>
			<td><%= @reservation.id %></td>
		</tr>
		<tr>
			<th>
				<% if @reservation.member_id == current_member.id %>
					予約相手（特別会員）
				<% else %>
					予約者
				<% end %>
			</th>
			<td>
				<% if @reservation.member_id == current_member.id %>
					<%= @reservation.target_member.name %> さん
				<% else %>
					<%= @reservation.member.name %> さん
				<% end %>
			</td>
		</tr>
		<tr>
			<th>日時</th>
			<td>
				<%= @reservation.start_at.strftime("%Y年%m月%d日 %H:%M") %> 〜 
				<%= @reservation.end_at.strftime("%H:%M") %>
			</td>
		</tr>
		<tr>
			<th>利用時間</th>
			<td><%= @reservation.hours %> 時間</td>
		</tr>
		<tr>
			<th>一言コメント</th>
			<td><%= simple_format(@reservation.comment) %></td>
		</tr>
		<tr>
			<th>合計金額</th>
			<td>
				<% total_price = @reservation.hours * @reservation.target_member.price_per_hour %>
				<%= number_with_delimiter(total_price) %> 円
			</td>
		</tr>
		<tr>
			<th>操作</th>
			<td>
				<% target_member = @reservation.member_id == current_member.id ? @reservation.target_member : @reservation.member %>
				<% if current_member.blocking?(target_member) %>
					<%= button_to "ブロック解除", member_block_path(target_member), method: :delete, class: "btn-secondary btn-sm", form: { data: { turbo_confirm: "本当に解除しますか？" } } %>
				<% else %>
					<%= button_to "ブロックする", member_block_path(target_member), method: :post, class: "btn-outline-danger btn-sm", form: { data: { turbo_confirm: "本当にブロックしますか？" } } %>
				<% end %>
			</td>
		</tr>
	</table>

    <% if @reservation.admin_canceled? %>
        <div class="alert">
            <% banned_name = @reservation.member.is_banned ? @reservation.member.name : (@reservation.target_member.is_banned ? @reservation.target_member.name : nil) %>
            <% if banned_name.present? %>
                <strong><%= banned_name %></strong> さんがBANされたため、この取引はキャンセルされました。
            <% else %>
                管理者によりこの取引はキャンセルされました。
            <% end %>
        </div>
    <% end %>

	<% if @reservation.completed? %>
        <div class="review-section">
            <h3>評価とコメント</h3>
            
            <% if @reservation.review.present? %>
                <p><strong>スコア:</strong> <%= "★" * @reservation.review.score %></p>
                <p><%= simple_format(@reservation.review.content) %></p>
            <% elsif current_member.id == @reservation.member_id %>
                <%= form_with(model: [@reservation, Review.new], url: reservation_review_path(@reservation), local: true) do |f| %>
                    <div class="field">
                    <%= f.label :score, "評価 (1〜5)" %><br>
                    <%= f.select :score, (1..5).to_a.reverse.map { |i| ["★" * i, i] } %>
                    </div>
                    <div class="field">
                    <%= f.label :content, "コメント" %><br>
                    <%= f.text_area :content, rows: 3 %>
                    </div>
                    <div class="actions">
                    <%= f.submit "レビューを投稿する", class: "btn-primary" %>
                    </div>
                <% end %>
            <% else %>
                <p>まだ評価が届いていません。</p>
            <% end %>
        </div>
	<% end %>

	<div class="report-section">
		<%= link_to "この予約に関する問題を通報する", new_reservation_report_path(@reservation), class: "btn-danger" %>
	</div>

	<div class="action-buttons mt-20">
		<% if current_member.id == @reservation.member_id && !@reservation.canceled? && !@reservation.completed? %>
			<%= button_to "予約をキャンセルする", cancel_reservation_path(@reservation), method: :patch, class: "btn-danger", form: { data: { turbo: false }, onsubmit: "return confirm('本当にこの予約をキャンセルしますか？');" } %>
			<% if @reservation.approved_unpaid? %>
				<%= button_to "支払う", pay_reservation_path(@reservation), method: :patch, class: "btn-primary", form: { data: { turbo: false }, onsubmit: "return confirm('支払いを実行しますか？');" } %>
			<% end %>
		<% end %>

		<% if current_member.id == @reservation.target_member_id %>
			
			<% if @reservation.pending? %>
                <div class="d-flex gap-10">
                    <%= button_to "承諾する", update_status_reservation_path(@reservation, status: 'approved'), method: :patch, class: "btn-primary", form: { data: { turbo_confirm: "承諾しますか？" } } %>
                    <%= button_to "却下する", update_status_reservation_path(@reservation, status: 'rejected'), method: :patch, class: "btn-danger", form: { data: { turbo_confirm: "却下しますか？" } } %>
                </div>

			<% elsif @reservation.approved_unpaid? %>
                <div class="status-alert-success mb-10">
                    現在「承諾(未払い)」です。
                </div>
                <%= button_to "承諾を取り消す", update_status_reservation_path(@reservation, status: 'pending'), method: :patch, class: "btn-secondary" %>

			<% elsif @reservation.approved_paid? %>
                <div class="status-alert-success mb-10">
                    現在「承諾(支払い済み)」です。
                </div>

			<% elsif @reservation.rejected? %>
                <div class="alert mb-10">
                    現在「却下」しています。
                </div>
			    <%= button_to "却下を取り消す", update_status_reservation_path(@reservation, status: 'pending'), method: :patch, class: "btn-secondary" %>
			<% end %>
		<% end %>
	</div>

	<div class="actions">
		<%= link_to "チャット", reservation_chats_path(@reservation), class: "btn-primary" %> |
		<%= link_to "予約一覧へ戻る", reservations_path %> | 
		<%= link_to "トップページへ戻る", root_path %>
	</div>
</div>
